<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/app-route/app-location.html">
<link rel="import" href="bower_components/app-route/app-route.html">
<link rel="import" href="bower_components/app-storage/app-network-status-behavior.html">
<link rel="import" href="bower_components/app-layout/app-layout.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-icons/maps-icons.html">
<link rel="import" href="bower_components/iron-icons/communication-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-selector/iron-selector.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="arpa_components/arpa-app-elements/arpa-common-elements.html">
<link rel="import" href="arpa_components/arpa-notes-example/arpa-notes-example.html">
<link rel="import" href="arpa_components/arpa-search-element/arpa-search-element.html">
<link rel="import" href="arpa_components/arpa-company-example/arpa-mycompany-element.html">
<link rel="import" href="arpa_components/arpa-bus-models/arpa-bus-models.html">
<link rel="import" href="arpa_components/arpa-routes/arpa-routes.html">

<dom-module id="arpa-app">
    <template>
        <style include="arpa-app-shared-styles">
        </style>
        <paper-toast id="defaultToast" text=""></paper-toast>
        <paper-toast id="persistentToast" duration="0" text="">
            <paper-button onclick="Arpa.persistentToast.close()" class="yellow-button">{{localize("close")}}</paper-button>
        </paper-toast>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}"
                   pattern="/:page"
                   data="{{routeData}}"
                   tail="{{subroute}}">
        </app-route>
        <app-header-layout>
            <app-header fixed="" effects="waterfall" slot="header"
                        style="transition-duration: 0ms; transform: translate3d(0px, 0px, 0px); left: 0px; right: 0px;">
                <app-toolbar>
                    <paper-icon-button icon="menu" on-tap="_drawerToggle"></paper-icon-button>
                    <div main-title>ARPA</div>
                    <div class="user-icon-container" hidden$="[[!signedIn]]">
                        <label>{{_getUserName(user)}}</label>
                        <img class="user-icon" src="[[_getUserIcon(user)]]"/>
                    </div>
                    <iron-icon icon="cloud" hidden$="[[!online]]"></iron-icon>
                    <iron-icon icon="cloud-off" hidden$="[[online]]"></iron-icon>
                    <paper-icon-button class="login-status"
                                       title="[[_computeLockTitle(signedIn)]]"
                                       icon="[[_computeLockIcon(signedIn)]]"
                                       on-tap="_switchLoginStatus">
                    </paper-icon-button>
                </app-toolbar>
            </app-header>
            <app-drawer-layout id="drawerLayout">
                <app-drawer id="drawer" slot="drawer" position="left" style="transition-duration: 200ms; touch-action: pan-y;" persistent opened>
                    <paper-listbox attr-for-selected="value" selected="{{routeData.page}}" fallback-selection="search-element">
                        <paper-item value="search" on-tap="_setupSelectedPage">
                            <iron-icon icon="search"></iron-icon>
                            <label>{{localize('search_routes')}}</label>
                        </paper-item>
                        <template is="dom-if" if="{{signedIn}}">
                            <paper-item value="notes" on-tap="_setupSelectedPage">
                                <iron-icon icon="icons:speaker-notes"></iron-icon>
                                <label>{{localize('note_example')}}</label>
                            </paper-item>
                            <paper-item value="userroles" on-tap="_setupSelectedPage">
                                <iron-icon icon="social:group"></iron-icon>
                                <label>{{localize('user_roles')}}</label>
                            </paper-item>
                            <paper-item value="busmodels" on-tap="_setupSelectedPage">
                                <iron-icon icon="maps:directions-bus"></iron-icon>
                                <label>{{localize('bus_models')}}</label>
                            </paper-item>
                            <paper-item value="routes" on-tap="_setupSelectedPage">
                                <iron-icon icon="maps:directions"></iron-icon>
                                <label>{{localize('my_routes')}}</label>
                            </paper-item>
                            <paper-item value="mycompany" on-tap="_setupSelectedPage">
                                <iron-icon icon="communication:contacts"></iron-icon>
                                <label>{{localize('my_company')}}</label>
                            </paper-item>
                        </template>
                    </paper-listbox>
                </app-drawer>
                <div class="pages-container">
                    <iron-pages role="main"
                                selected="[[routeData.page]]"
                                attr-for-selected="name"
                                selected-attribute="visible"
                                hidden$="[[!online]]">
                        <arpa-search-element id="search"
                                             name="search"
                                             route="{{subroute}}">
                        </arpa-search-element>
                        <arpa-notes-example id="notes"
                                            name="notes"
                                            route="{{subroute}}"
                                            user="{{user}}"
                                            signed-in="{{signedIn}}"
                                            online="{{online}}"
                                            hidden$="[[!signedIn]]">
                        </arpa-notes-example>
                        <arpa-company-element id="mycompany"
                                              name="mycompany"
                                              route="{{subroute}}"
                                              user="{{user}}"
                                              signed-in="{{signedIn}}"
                                              online="{{online}}"
                                              hidden$="[[!signedIn]]">
                        </arpa-company-element>
                        <arpa-bus-models id="busmodels"
                                         name="busmodels"
                                         route="{{subroute}}"
                                         user="{{user}}"
                                         signed-in="{{signedIn}}"
                                         online="{{online}}"
                                         hidden$="[[!signedIn]]">
                        </arpa-bus-models>
                        <arpa-routes id="routes"
                                     name="routes"
                                     route="{{subroute}}"
                                     user="{{user}}"
                                     signed-in="{{signedIn}}"
                                     online="{{online}}"
                                     hidden$="[[!signedIn]]">
                        </arpa-routes>
                    </iron-pages>
                </div>
            </app-drawer-layout>
        </app-header-layout>

    </template>
    <script>
        Polymer({
            is: 'arpa-app',

            properties: {
                routeData: {
                    type: String,
                    notify: true,
                    value: "search-element"
                }
            },

            behaviors: [Polymer.ArpaCore, Polymer.ArpaAppBehavior, Polymer.ArpaMessages],

            ready: function () {
                this._setupUserSettings(firebaseApp.auth().currentUser);
                firebaseApp.auth().onAuthStateChanged(function (_user) {
                    this._setupUserSettings(_user);
                }.bind(this));
                var connectedRef = firebaseApp.database().ref(".info/connected");
                connectedRef.on("value", function (snap) {
                    this.online = (snap.val() === true);
                }.bind(this));
                window.Arpa.defaultToast = this.$.defaultToast;
                window.Arpa.persistentToast = this.$.persistentToast;
            },

            _setupUserSettings: function (_user) {
                this.set("user", _user);
                if (_user) {
                    this.set("signedIn", true);
                } else {
                    this.set("signedIn", false);
                }
                ;
            },

            _setupSelectedPage: function(_event) {
                var elementId = _event.currentTarget.getAttribute("value");
                if (this.$[elementId] !== null && typeof this.$[elementId].setup === "function") {
                    this.$[elementId].setup();
                }
            },

            _computeLockIcon: function (_signedIn) {
                return _signedIn ? 'lock-open' : 'lock';
            },

            _computeLockTitle: function (_signedIn) {
                return _signedIn ? 'Logout' : 'Login';
            },

            _isLoginRequired: function (_page) {
                return _page === "notes_example";
            },

            _drawerToggle: function (_event) {
                this.$.drawer.toggle();
                if (this.$.drawerLayout.forceNarrow || !this.$.drawerLayout.narrow) {
                    this.$.drawerLayout.forceNarrow = !this.$.drawerLayout.forceNarrow;
                } else {
                    this.$.drawerLayout.drawer.toggle();
                }
            },

            _switchLoginStatus: function () {
                if (this.signedIn) {
                    this.authSignOut();
                } else {
                    this.authSignInWithPopup();
                }
            },
            authSignInWithPopup: function () {
                firebaseApp.auth().signInWithPopup(authProvider)
                    .then(function (result) {
                        var token = result.credential.accessToken;
                        var user = result.user;
                        this._setupUserSettings(user);
                    }.bind(this))
                    .catch(function (error) {
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        this.showErrorMessage(error);
                        this._setupUserSettings(null);
                    }.bind(this));
            },
            authSignOut: function () {
                firebaseApp.auth().signOut()
                    .then(function () {
                        this._setupUserSettings(null);
                    }.bind(this), function (error) {
                        this._setupUserSettings(null);
                    }.bind(this));
            },

            _getUserIcon: function (_user) {
                return _user && _user.photoURL ? _user.photoURL : "./arpa_components/arpa-app-elements/images/icon-1x.png";
            },

            _getUserName: function (_user) {
                return _user ? _user.displayName : "";
            }
        });

    </script>
</dom-module>