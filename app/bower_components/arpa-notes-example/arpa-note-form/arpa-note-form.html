<link rel="import" href="../../arpa-app-elements/arpa-elements.html">
<link rel="import" href="../../polymerfire/polymerfire.html">
<link rel="import" href="../../paper-input/all-imports.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../arpa-app-elements/arpa-common-behaviors.html">

<dom-module id="arpa-note-form">
    <template>
        <style include="arpa-app-shared-styles"></style>
        <div class="page-content">
            <h3>[[getPageTitle(mode)]]</h3>
            <div class="form-content">
                <paper-input id="titleField"
                             value="{{note.title}}"
                             error-message="{{es.message.note_title_error}}"
                             label="[[es.label.note_title]]"
                             char-counter="true"
                             maxlength="50"
                             required="true"
                             auto-validate="true"></paper-input>
                <br>
                <paper-textarea id="bodyField"
                                value="{{note.body}}"
                                error-message="{{es.message.note_body_error}}"
                                label="[[es.label.note_body]]"
                                char-counter="true"
                                maxlength="500"
                                auto-validate="true">
                </paper-textarea>
            </div>
            <div class="page-buttons">
                <paper-button on-tap="delete" hidden$="[[!isEditMode(mode)]]">{{es.label.delete}}</paper-button>
                <paper-button on-tap="save" hidden$="[[isNoneMode(mode)]]">{{es.label.save}}</paper-button>
                <paper-button on-tap="cancel" hidden$="[[isNoneMode(mode)]]">{{es.label.cancel}}</paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'arpa-note-form',

            properties: {
                mode: {
                    type: String,
//                    ["NONE", "CREATE", "EDIT"]
                    value: "NONE",
                    notify: true
                },
                user: {
                    type: Object,
                    value: {},
                    notify: true
                },
                noteId: {
                    type: String,
                    value: null,
                    notify: true
                },
                note: {
                    type: Object,
                    value: {
                        title: "",
                        body: ""
                    },
                    reflectToAttribute: true,
                    notify: true
                },
                editableNotePath: {
                    type: String,
                    value: null,
                    notify: true
                }
            },

            behaviors: [Polymer.ArpaMessages, Polymer.ArpaCoreModel, Polymer.ArpaForms],

            observers: [
//                'setup(mode, noteId)'
            ],

            isNoneMode: function (_mode) {
                return !_mode || _mode === "NONE";
            },

            isEditMode: function (_mode) {
                return _mode === "EDIT";
            },

            isAddMode: function (_mode) {
                return _mode === "ADD";
            },

            getPageTitle: function (_mode) {
                return this.isEditMode(_mode) ? this.es.message.note_edit_title : this.isAddMode(_mode) ? this.es.message.note_add_title : "";
            },

            setup: function (_mode, _note) {
                this.mode = _mode;
                //Setup default values
                console.log("note", this.note);
                this.noteId = null;
                if (this.isNoneMode(this.mode)) {
                    this.note = null;
                } else if (this.isEditMode(this.mode)) {
                    this.noteId = _note.$id;
                    this.note = this.toEditableObject(_note);
                    this.setPropertiesFromEntity("note", ["title", "body"]);
                    this.clearFieldsValidation(["titleField", "bodyField"], false);
                } else if (this.isAddMode(this.mode)) {
                    this.noteId = null;
                    this.note = {title: "", body: ""};
                    this.setPropertiesFromEntity("note", ["title", "body"]);
                    this.clearFieldsValidation(["titleField", "bodyField"], true);
                }
                return Promise.resolve();
            },

            delete: function (_event) {
                var recordRef = firebaseApp.database().ref(this.recordPath);
                recordRef.remove(null);
                this.fire('change-view', {mode: "NONE", note: null, view: "list"});
                return Promise.resolve();
            },

            save: function (_event) {
                console.log("save", _event);
                if (this.performFieldsValidation(["titleField", "bodyField"])) {
                    this.pushPropertiesToEntity("note", ["title", "body"]);

                    if (this.isAddMode(this.mode)) {
                        console.log("this.note", this.note);
                        var recordRef = firebaseApp.database().ref(this.notesPath);
                        var result = recordRef.push(this.note);
                        console.log("result", result);
                    } else if (this.isEditMode(this.mode)) {
                        console.log("this.recordPath", this.recordPath);
                        var recordRef = firebaseApp.database().ref(this.recordPath);
                        var result = recordRef.update(this.note);
                        console.log("result", result);
                    } else {
                        console.error("Unsupported action.")
                    }
                    this.fire('change-view', {mode: "NONE", note: null, view: "list"});
                }
                return Promise.resolve();
            },

            cancel: function (_event) {
                this.fire('change-view', {mode: "NONE", note: null, view: "list"});
            },

            get notesPath() {
                return '/notes/user_' + this.user.uid;
            },

            get recordPath() {
                return this.notesPath + "/" + this.noteId;
            },

            get isEditable() {
                return this.online;
            }
        });
    </script>
</dom-module>