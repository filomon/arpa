<link rel="import" href="../../arpa-app-elements/arpa-common-elements.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../arpa-app-elements/arpa-common-behaviors.html">

<dom-module id="arpa-bus-model-form">
    <template>
        <style include="arpa-app-shared-styles"></style>
        <div class="page-content">
            <h3>[[_getPageHeader(mode)]]</h3>
            <div class="form-content">
                <vaadin-form-layout>
                    <vaadin-text-field id="nameField"
                                 value="{{busModelId}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('name')}}"
                                 char-counter="true"
                                 maxlength="50"
                                 required="true"
                                 auto-validate="true"
                                 readonly="{{isEditMode(mode)}}">
                    </vaadin-text-field>
                    <vaadin-text-area id="descriptionField"
                                    value="{{busModel.description}}"
                                    error-message="{{localize('error_invalid')}}"
                                    label="{{localize('description')}}"
                                    char-counter="true"
                                    maxlength="500"
                                    required="true"
                                    auto-validate="true">
                    </vaadin-text-area>
                    <vaadin-combo-box id="trademarkField"
                                      error-message="{{localize('error_invalid')}}"
                                      label="{{localize('trademark')}}"
                                      value="{{busModel.trademark}}"
                                      items="[[trademarks]]"
                                      required="true">
                    </vaadin-combo-box>
                    <vaadin-combo-box id="confortField"
                                      error-message="{{localize('error_invalid')}}"
                                      label="{{localize('confort')}}"
                                      value="{{busModel.confort}}"
                                      items="[[confortTypes]]"
                                      required>
                    </vaadin-combo-box>
                    <vaadin-text-field id="floorsNumberField"
                                 value="{{busModel.floorsNumber}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('floors_number')}}"
                                 readonly="true">
                    </vaadin-text-field>
                    <vaadin-text-field id="seatsNumberField"
                                 value="{{busModel.seatsNumber}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('seats_number')}}"
                                 readonly="true">
                    </vaadin-text-field>
                    <vaadin-text-field id="toiletNumberField"
                                 value="{{busModel.toiletNumber}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('toilet_number')}}"
                                 readonly="true">
                    </vaadin-text-field>
                    <vaadin-text-field id="tvNumberField"
                                 value="{{busModel.tvNumber}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('tv_number')}}"
                                 readonly="true">
                    </vaadin-text-field>
                </vaadin-form-layout>
            </div>
            <div class="page-buttons">
                <paper-button raised on-tap="save" hidden$="[[isNoneMode(mode)]]">{{localize('save')}}</paper-button>
                <paper-button raised on-tap="cancel" hidden$="[[isNoneMode(mode)]]">{{localize('cancel')}}</paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'arpa-bus-model-form',

            properties: {
                busModelId: {
                    type: String,
                    value: null,
                    notify: true
                },
                busModel: {
                    type: Object,
                    value: {
                        title: null,
                        body: null
                    },
                    notify: true
                },
                trademarks: {
                    type: Array,
                    value: null
                },
                confortTypes: {
                    type: Array,
                    value: ["Normal", "Cama", "Suite Cama"]
                }
            },

            behaviors: [Polymer.ArpaCore, Polymer.ArpaMessages, Polymer.ArpaForms, Polymer.ArpaQueries, Polymer.ArpaCollections],

            _getPageHeader: function (_mode) {
                return this.isEditMode(_mode) ? this.localize('edit_header') : this.isAddMode(_mode) ? this.localize('add_header') : "";
            },

            _loadFormData: function () {
                return firebaseApp.database().ref("/bus_trademarks").orderByKey().once("value")
                    .then(function (data) {
                        this.set("trademarks", this.getObjectKeys(data.val()))
                    }.bind(this));
            },

            _validateUniqueModelName: function () {
                return firebaseApp.database().ref(this.recordPath).orderByKey().once("value")
                    .then(function (data) {
                        return (data === null || data.val() === null);
                    }.bind(this));
            },

            setup: function (_mode, _busModel) {
                this.mode = _mode;
                //Setup default values
                console.log("busModel", this.busModel);
                this.busModelId = null;
                if (this.isNoneMode(this.mode)) {
                    this.busModel = null;
                } else if (this.isEditMode(this.mode)) {
                    this._loadFormData().then(function (data) {
                        this.busModelId = _busModel.$id;
                        this.busModel = this.toEditableObject(_busModel);
                        this.setPropertiesFromEntity("busModel", ["description", "trademark", "confort",
                                                                  "floorsNumber", "seatsNumber", "toiletNumber",
                                                                  "tvNumber"]);
                        this.clearFieldsValidation(["nameField", "descriptionField"], false);
                    }.bind(this));
                } else if (this.isAddMode(this.mode)) {
                    this._loadFormData().then(function (data) {
                        this.busModelId = null;
                        this.busModel = {description: "", trademark: "", confort: "",
                                         floorsNumber: 0, seatsNumber: 0, toiletNumber: 0, tvNumber: 0};
                        //Createting the accessing of every property of busModel json
                        this.setPropertiesFromEntity("busModel", ["description", "trademark", "confort",
                                                                  "floorsNumber", "seatsNumber", "toiletNumber",
                                                                  "tvNumber"]);
                        //Cleared out every field in the form listed below.
                        this.clearFieldsValidation(["nameField", "descriptionField", "trademarkField", "confortField"], true);
                    }.bind(this));
                }
                return Promise.resolve();
            },

            save: function (_event) {
                //Validate input fields
                if (this.performFieldsValidation(["nameField", "descriptionField", "trademarkField", "confortField"])) {
                    //Set busModel properties from UI
                    this.pushPropertiesToEntity("busModel", ["description", "trademark", "confort",
                                                             "floorsNumber", "seatsNumber", "toiletNumber",
                                                             "tvNumber"]);
                    if (this.isAddMode(this.mode)) {
                        this._validateUniqueModelName().then(function (data) {
                          if (data) {
                            var recordRef = firebaseApp.database().ref(this.recordPath);
                            var result = recordRef.set(this.busModel);
                            this.showSuccessMessage(this.localize("success_add", "name", this.busModelId));
                            this.fire('change-view', {mode: "NONE", busModel: null, view: "list"});
                          } else {
                              this.showErrorMessage(this.localize("duplicated_model_name", "name", this.busModelId));
                          }
                        }.bind(this));
                    } else if (this.isEditMode(this.mode)) {
                        var recordRef = firebaseApp.database().ref(this.recordPath);
                        var result = recordRef.update(this.busModel);
                        this.showSuccessMessage(this.localize("success_edit", "name", this.busModelId));
                    } else {
                        this.showErrorMessage(this.localize("unsupported_action"));
                    }

                }
                return Promise.resolve();
            },

            cancel: function (_event) {
                this.fire('change-view', {mode: "NONE", busModel: null, view: "list"});
            },

            get busModelsPath() {
                return '/bus_models';
            },

            get recordPath() {
                return this.busModelsPath + "/" + this.busModelId;
            }
        });
    </script>
</dom-module>