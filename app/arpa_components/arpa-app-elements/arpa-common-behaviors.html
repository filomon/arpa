<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
    (function () {
        'use strict';
        /**
         * @polymerBehavior Polymer.ArpaMessages
         */
        Polymer.ArpaMessages = {
            /**
             * Sets message text.
             *
             * @param _elment
             * @param _msg
             * @private
             */
            _setMessage: function (_elment, _msg) {
                if (typeof _msg === "object" && (_msg.code || _msg.message)) {
                    _elment.text = (_msg.code && _msg.message) ? _msg.code + ": " + _msg.message : _msg.code ? _msg.code : _msg.message;
                } else {
                    _elment.text = _msg;
                }
            },

            /**
             * Shows global information message.
             *
             * @param _msg
             */
            showInfoMessage: function (_msg) {
                if (Arpa.defaultToast) {
                    this._setMessage(Arpa.defaultToast, _msg);
                    Arpa.defaultToast.classList.remove("success-message", "info-message");
                    Arpa.defaultToast.classList.add("info-message");
                    Arpa.defaultToast.open();
                }
            },

            /**
             * Shows global success message.
             *
             * @param _msg
             */
            showSuccessMessage: function (_msg) {
                if (Arpa.defaultToast) {
                    this._setMessage(Arpa.defaultToast, _msg);
                    Arpa.defaultToast.classList.remove("success-message", "info-message");
                    Arpa.defaultToast.classList.add("success-message");
                    Arpa.defaultToast.open();
                }
            },

            /**
             * Shows global error message.
             * @param _msg
             */
            showErrorMessage: function (_msg) {
                if (Arpa.persistentToast) {
                    this._setMessage(Arpa.persistentToast, _msg);
                    Arpa.persistentToast.classList.remove("error-message", "info-message");
                    Arpa.persistentToast.classList.add("error-message");
                    Arpa.persistentToast.open();
                }
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaCore
         */
        Polymer.ArpaCoreImpl = {
            properties: {
                user: {
                    type: Object,
                    value: {},
                    notify: true
                },
                accessToken: {
                    type: String,
                    value: null,
                    notify: true
                },
                signedIn: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                online: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                language: {
                    type: String,
                    value: "es",
                    notify: true
                }
            },

            /**
             * Loads resources when "attached" Polymer event is triggered.
             */
            attached: function () {
                if (this.loadResources) {
                    this.loadResources(this.resolveUrl('locales.json'));
                }
            },

            isRoot: function(_userRole) {
                return _userRole.role === "ROOT";
            },

            isQuest: function(_userRole) {
                return !_userRole || !_userRole.role || _userRole.role === "GUEST";
            },

            isCompanyAdmin: function(_userRole) {
                return _userRole.role === "COMPANY_ADMIN";
            },

            isSystemAdmin: function(_userRole) {
                return _userRole.role === "SYSTEM_ADMIN";
            }
        };

        Polymer.ArpaCore = [Polymer.AppLocalizeBehavior, Polymer.ArpaCoreImpl];

        /**
         * @polymerBehavior Polymer.ArpaForms
         */
        Polymer.ArpaForms = {
            properties: {
                mode: {
                    type: String,
                    value: "NONE",
                    notify: true
                }
            },

            /**
             * Defines if mode is NONE.
             *
             * @param _mode The mode current value
             * @returns {boolean}
             */
            isNoneMode: function (_mode) {
                return !_mode || _mode === "NONE";
            },

            /**
             * Defines if mode is EDIT.
             *
             * @param _mode The mode current value
             * @returns {boolean}
             */
            isEditMode: function (_mode) {
                return _mode === "EDIT";
            },

            /**
             * Defines if mode is ADD.
             *
             * @param _mode The mode current value
             * @returns {boolean}
             */
            isAddMode: function (_mode) {
                return _mode === "ADD";
            },

            /**
             * Creates a clone of an object.
             *
             * @param _object
             * @returns {*|Object}
             */
            cloneObject: function (_object) {
                return JSON.parse(JSON.stringify(_object));
            },

            /**
             * Creates a clone of an object and removes "$id" property.
             *
             * @param _object
             * @returns {*|Object}
             */
            toEditableObject: function (_object) {
                var clonedObj = this.cloneObject(_object);
                delete clonedObj["$id"];
                return clonedObj;
            },

            /**
             * Performs a generic fields validation based on an list of fields id.
             *
             * @param _fieldIds The fields id to validate.
             * @returns {boolean}
             */
            performFieldsValidation: function (_fieldIds) {
                var valid = true;
                for (var fieldPosition = 0; fieldPosition < _fieldIds.length; fieldPosition++) {
                    if (this.$[_fieldIds[fieldPosition]]) {
                        this.$[_fieldIds[fieldPosition]].validate();
                        if (this.$[_fieldIds[fieldPosition]].invalid) {
                            valid = false;
                        }
                    } else {
                        console.log("Field not found: " + _fieldIds[fieldPosition]);
                    }
                }
                return valid;
            },

            /**
             * Clears fields content and hides fields validations based on an list of fields id and _clearFields flag.
             *
             * @param _fieldIds The fields id to manage.
             * @param _clearFields
             */
            clearFieldsValidation: function (_fieldIds, _clearFields) {
                for (var fieldPosition = 0; fieldPosition < _fieldIds.length; fieldPosition++) {
                    if (this.$[_fieldIds[fieldPosition]]) {
                        if (_clearFields && this.$[_fieldIds[fieldPosition]].clear) {
                            this.$[_fieldIds[fieldPosition]].clear();
                        }
                        this.$[_fieldIds[fieldPosition]].invalid = false;
                    } else {
                        console.log("Field not found: " + _fieldIds[fieldPosition]);
                    }
                }
            },

            /**
             * Sets property values(_objectName._propertyName) from source object to Polymer context.
             *
             * @param _objectName The object name to manage.
             * @param _propertyNames The properties name.
             */
            setPropertiesFromEntity: function (_objectName, _propertyNames) {
                var jsonObject = this.get(_objectName);
                for (var propPosition = 0; propPosition < _propertyNames.length; propPosition++) {
                    var propertyName = _propertyNames[propPosition];
                    var propertyValue = jsonObject[propertyName];
                    var propertyPath = _objectName + "." + propertyName;
                    this.set(propertyPath, propertyValue);
                }
            },

            /**
             *  Sets property values(_objectName._propertyName) from Polymer context to target object.
             * @param _objectName
             * @param _propertyNames
             */
            pushPropertiesToEntity: function (_objectName, _propertyNames) {
                var jsonObject = this.get(_objectName);
                for (var propPosition = 0; propPosition < _propertyNames.length; propPosition++) {
                    var propertyName = _propertyNames[propPosition];
                    var propertyPath = _objectName + "." + propertyName;
                    var propertyValue = this.get(propertyPath);
                    if (typeof propertyValue !== 'undefined') {
                        jsonObject[propertyName] = propertyValue;
                    }
                }
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaQueries
         */
        Polymer.ArpaQueries = {
            /**
             * Returns company name associated to current user.
             *
             * @returns {promise}
             */
            getCurrentUserCompanyName: function () {
                return firebaseApp.database().ref("/companies").orderByChild("owner").equalTo(this.user.uid).once("value").then(function (data) {
                    if (data && data.val()) {
                        var keys = this.getObjectKeys(data.val());
                        if (keys && keys.length > 0) {
                            return keys[0];
                        }
                    }
                    return null;
                }.bind(this));
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaCollections
         */
        Polymer.ArpaCollections = {
            properties: {
                searchText: {
                    type: String,
                    value: "",
                    notify: true
                }
            },

            /**
             * Generic logic to filter an array.
             *
             * @param _array The array.
             * @param _searchText The search text.
             */
            filterArray: function (_array, _searchText) {
                if (null === _array) {
                    return [];
                }
                var _searchTextLC = _searchText.toLowerCase();
                var _arguments = arguments;
                return _array.filter(function (item, index) {
                    var found = true;
                    for (var criteriaIndex = 2; criteriaIndex < _arguments.length && found; criteriaIndex++) {
                        if (typeof _arguments[criteriaIndex] === "function") {
                            found = _arguments[criteriaIndex](this, item, index);
                        } else if (typeof _arguments[criteriaIndex] === "string") {
                            var propertyValue = item[_arguments[criteriaIndex]];
                            found = propertyValue && (("" + propertyValue).toLowerCase().match(_searchTextLC));
                        }
                    }
                    return found;
                }.bind(this));
            },

            /**
             * Converts firebase query result to an simple array with json object.
             *
             * @param _queryResult The query result.
             * @param filterFn Custom function to filter properties and values.
             * @returns {Array}
             */
            queryResultsToArrayObject: function (_queryResult, filterFn) {
                var resultArray = [];
                if (_queryResult) {
                    for (var key in _queryResult) {
                        if (_queryResult.hasOwnProperty(key) && (!filterFn || (typeof filterFn === "function" && filterFn(key, _queryResult[key])))) {
                            if (typeof _queryResult[key] === "object") {
                                var jsonObject = _queryResult[key];
                                jsonObject["$id"] = key;
                                resultArray.push(jsonObject);
                            }
                        }
                    }
                }
                return resultArray;
            },
            /**
             * Returns the object properties name.
             *
             * @param _queryResult The query result.
             * @param filterFn Custom function to filter properties and values.
             * @returns {Array}
             */
            getObjectKeys: function (_queryResult, filterFn) {
                var resultArray = [];
                if (_queryResult) {
                    for (var key in _queryResult) {
                        if (!filterFn || (typeof filterFn === "function" && filterFn(key, _queryResult[key]))) {
                            resultArray.push(key);
                        }
                    }
                }
                return resultArray;
            }
        };
    })();
</script>
