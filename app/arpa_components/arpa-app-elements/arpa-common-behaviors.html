<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
    (function () {
        'use strict';
        /**
         * @polymerBehavior Polymer.ArpaMessages
         */
        Polymer.ArpaMessages = {
            _setMessage: function (_elment, _msg) {
                if (typeof _msg === "object" && (_msg.code || _msg.message)) {
                    _elment.text = (_msg.code && _msg.message) ? _msg.code + ": " + _msg.message : _msg.code ? _msg.code : _msg.message;
                } else {
                    _elment.text = _msg;
                }
            },
            showInfoMessage: function (_msg) {
                if (Arpa.defaultToast) {
                    this._setMessage(Arpa.defaultToast, _msg);
                    Arpa.defaultToast.classList.remove("success-message", "info-message");
                    Arpa.defaultToast.classList.add("info-message");
                    Arpa.defaultToast.open();
                }
            },
            showSuccessMessage: function (_msg) {
                if (Arpa.defaultToast) {
                    this._setMessage(Arpa.defaultToast, _msg);
                    Arpa.defaultToast.classList.remove("success-message", "info-message");
                    Arpa.defaultToast.classList.add("success-message");
                    Arpa.defaultToast.open();
                }
            },
            showErrorMessage: function (_msg) {
                if (Arpa.persistentToast) {
                    this._setMessage(Arpa.persistentToast, _msg);
                    Arpa.persistentToast.classList.remove("error-message", "info-message");
                    Arpa.persistentToast.classList.add("error-message");
                    Arpa.persistentToast.open();
                }
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaCore
         */
        Polymer.ArpaCoreImpl = {
            properties: {
                user: {
                    type: Object,
                    value: {},
                    notify: true
                },
                accessToken: {
                    type: String,
                    value: null,
                    notify: true
                },
                signedIn: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                online: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                language: {
                    type: String,
                    value: "es",
                    notify: true
                }
            },

            attached: function () {
                if (this.loadResources) {
                    this.loadResources(this.resolveUrl('locales.json'));
                }
            }
        };

        Polymer.ArpaCore = [Polymer.AppLocalizeBehavior, Polymer.ArpaCoreImpl];

        /**
         * @polymerBehavior Polymer.ArpaForms
         */
        Polymer.ArpaForms = {
            properties: {
                mode: {
                    type: String,
                    value: "NONE",
                    notify: true
                }
            },
            isNoneMode: function (_mode) {
                return !_mode || _mode === "NONE";
            },
            isEditMode: function (_mode) {
                return _mode === "EDIT";
            },
            isAddMode: function (_mode) {
                return _mode === "ADD";
            },
            cloneObject: function (_object) {
                return JSON.parse(JSON.stringify(_object));
            },
            toEditableObject: function (_object) {
                var clonedObj = this.cloneObject(_object);
                delete clonedObj["$id"];
                return clonedObj;
            },
            performFieldsValidation: function (_fieldIds) {
                var valid = true;
                for (var i = 0; i < _fieldIds.length; i++) {
                    if (this.$[_fieldIds[i]]) {
                        this.$[_fieldIds[i]].validate();
                        if (this.$[_fieldIds[i]].invalid) {
                            valid = false;
                        }
                    } else {
                        console.log("Field not found: " + _fieldIds[i]);
                    }
                }
                return valid;
            },
            clearFieldsValidation: function (_fieldIds, _clearFields) {
                for (var i = 0; i < _fieldIds.length; i++) {
                    if (this.$[_fieldIds[i]]) {
                        if (_clearFields && this.$[_fieldIds[i]].clear) {
                            this.$[_fieldIds[i]].clear();
                        }
                        this.$[_fieldIds[i]].invalid = false;
                    } else {
                        console.log("Field not found: " + _fieldIds[i]);
                    }
                }
            },
            setPropertiesFromEntity: function (_objectName, _propertyNames) {
                var jsonObject = this.get(_objectName);
                for (var i = 0; i < _propertyNames.length; i++) {
                    var propertyName = _propertyNames[i];
                    var propertyValue = jsonObject[propertyName];
                    var propertyPath = _objectName + "." + propertyName;
                    this.set(propertyPath, propertyValue);
                }
            },
            pushPropertiesToEntity: function (_objectName, _propertyNames) {
                var jsonObject = this.get(_objectName);
                for (var i = 0; i < _propertyNames.length; i++) {
                    var propertyName = _propertyNames[i];
                    var propertyPath = _objectName + "." + propertyName;
                    var propertyValue = this.get(propertyPath);
                    if (typeof propertyValue !== 'undefined') {
                        jsonObject[propertyName] = propertyValue;
                    }
                }
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaQueries
         */
        Polymer.ArpaQueries = {
            getCurrentUserCompanyName: function () {
                return firebaseApp.database().ref("/companies").orderByChild("owner").equalTo(this.user.uid).once("value").then(function (data) {
                    if (data && data.val()) {
                        var keys = this.getObjectKeys(data.val());
                        if (keys && keys.length > 0) {
                            return keys[0];
                        }
                    }
                    return null;
                }.bind(this));
            }
        };

        /**
         * @polymerBehavior Polymer.ArpaCollections
         */
        Polymer.ArpaCollections = {
            properties: {
                searchText: {
                    type: String,
                    value: "",
                    notify: true
                }
            },
            filterArray: function (_array, _searchText) {
                var _searchTextLC = _searchText.toLowerCase();
                var _arguments = arguments;
                return _array.filter(function (item, index) {
                    var found = false;
                    for (var i = 2; i < _arguments.length && !found; i++) {
                        if (typeof _arguments[i] === "function") {
                            found =  _arguments[i](this, item, index);
                        } else if (_searchTextLC && typeof _arguments[i] === "string") {
                            var propertyValue = item[_arguments[i]];
                            found = propertyValue && (("" + propertyValue).toLowerCase().match(_searchTextLC));
                        }
                    }
                    return found;
                }.bind(this));
            },
            queryResultsToArrayObject: function (_queryResult, filterFn) {
                var resultArray = [];
                if (_queryResult) {
                    for (var key in _queryResult) {
                        if (_queryResult.hasOwnProperty(key) && (!filterFn || (typeof filterFn === "function" && filterFn(key, _queryResult[key])))) {
                            if (typeof _queryResult[key] === "object") {
                                var jsonObject = _queryResult[key];
                                jsonObject["$id"] = key;
                                resultArray.push(jsonObject);
                            }
                        }
                    }
                }
                return resultArray;
            },
            getObjectKeys: function (_queryResult, filterFn) {
                var resultArray = [];
                if (_queryResult) {
                    for (var key in _queryResult) {
                        if (!filterFn || (typeof filterFn === "function" && filterFn(key, _queryResult[key]))) {
                            resultArray.push(key);
                        }
                    }
                }
                return resultArray;
            }
        };
    })();
</script>
