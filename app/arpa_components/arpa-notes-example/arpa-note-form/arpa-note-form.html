<link rel="import" href="../../arpa-app-elements/arpa-common-elements.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../arpa-app-elements/arpa-common-behaviors.html">

<dom-module id="arpa-note-form">
    <template>
        <style include="arpa-app-shared-styles"></style>
        <div class="page-content">
            <h3>[[_getPageHeader(mode)]]</h3>
            <div class="form-content">
                <paper-input id="titleField"
                             value="{{note.title}}"
                             error-message="{{localize('error_invalid')}}"
                             label="{{localize('title')}}"
                             char-counter="true"
                             maxlength="50"
                             required="true"
                             auto-validate="true"></paper-input>
                <br>
                <paper-textarea id="bodyField"
                                value="{{note.body}}"
                                error-message="{{localize('error_invalid')}}"
                                label="{{localize('body')}}"
                                char-counter="true"
                                maxlength="500"
                                auto-validate="true">
                </paper-textarea>
            </div>
            <div class="page-buttons">
                <paper-button raised on-tap="delete" hidden$="[[!isEditMode(mode)]]">{{localize('delete')}}</paper-button>
                <paper-button raised on-tap="save" hidden$="[[isNoneMode(mode)]]">{{localize('save')}}</paper-button>
                <paper-button raised on-tap="cancel" hidden$="[[isNoneMode(mode)]]">{{localize('cancel')}}</paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'arpa-note-form',

            properties: {
                mode: {
                    type: String,
//                    ["NONE", "CREATE", "EDIT"]
                    value: "NONE",
                    notify: true
                },
                noteId: {
                    type: String,
                    value: null,
                    notify: true
                },
                note: {
                    type: Object,
                    value: {
                        title: "",
                        body: ""
                    },
                    notify: true
                }
            },

            behaviors: [Polymer.ArpaCore, Polymer.ArpaMessages, Polymer.ArpaForms],

            observers: [
//                'setup(mode, noteId)'
            ],

            attached: function () {
                if (this.loadResources) {
                    this.loadResources(this.resolveUrl('locales.json'));
                }
            },

            isNoneMode: function (_mode) {
                return !_mode || _mode === "NONE";
            },

            isEditMode: function (_mode) {
                return _mode === "EDIT";
            },

            isAddMode: function (_mode) {
                return _mode === "ADD";
            },

            _getPageHeader: function (_mode) {
                return this.isEditMode(_mode) ? this.localize('edit_header') : this.isAddMode(_mode) ? this.localize('add_header') : "";
            },

            setup: function (_mode, _note) {
                this.mode = _mode;
                //Setup default values
                console.log("note", this.note);
                this.noteId = null;
                if (this.isNoneMode(this.mode)) {
                    this.note = null;
                } else if (this.isEditMode(this.mode)) {
                    this.noteId = _note.$id;
                    this.note = this.toEditableObject(_note);
                    this.setPropertiesFromEntity("note", ["title", "body"]);
                    this.clearFieldsValidation(["titleField", "bodyField"], false);
                } else if (this.isAddMode(this.mode)) {
                    this.noteId = null;
                    this.note = {title: "", body: ""};
                    this.setPropertiesFromEntity("note", ["title", "body"]);
                    this.clearFieldsValidation(["titleField", "bodyField"], true);
                }
                return Promise.resolve();
            },

            delete: function (_event) {
                var recordRef = firebaseApp.database().ref(this.recordPath);
                recordRef.remove(null);
                this.fire('change-view', {mode: "NONE", note: null, view: "list"});
                return Promise.resolve();
            },

            save: function (_event) {
                if (this.performFieldsValidation(["titleField", "bodyField"])) {
                    this.pushPropertiesToEntity("note", ["title", "body"]);

                    if (this.isAddMode(this.mode)) {
                        var recordRef = firebaseApp.database().ref(this.notesPath);
                        var result = recordRef.push(this.note);
                        this.showSuccessMessage(this.localize("success_add", "title", this.note.title));
                    } else if (this.isEditMode(this.mode)) {
                        var recordRef = firebaseApp.database().ref(this.recordPath);
                        var result = recordRef.update(this.note);
                        this.showSuccessMessage(this.localize("success_edit", "title", this.note.title));
                    } else {
                        this.showErrorMessage(this.localize("unsupported_action"));
                    }
                    this.fire('change-view', {mode: "NONE", note: null, view: "list"});
                }
                return Promise.resolve();
            },

            cancel: function (_event) {
                this.fire('change-view', {mode: "NONE", note: null, view: "list"});
            },

            get notesPath() {
                return '/notes/user_' + this.user.uid;
            },

            get recordPath() {
                return this.notesPath + "/" + this.noteId;
            },

            get isEditable() {
                return this.online;
            }
        });
    </script>
</dom-module>