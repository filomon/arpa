<link rel="import" href="../../arpa-app-elements/arpa-common-elements.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../bower_components/vaadin-grid/all-imports.html">
<link rel="import" href="../../arpa-app-elements/arpa-common-behaviors.html">

<dom-module id="arpa-route-form">
    <template>
        <style include="arpa-app-shared-styles"></style>
        <div class="page-content">
            <h3>[[_getPageHeader(mode, route.archived)]]</h3>
            <div class="form-content">
                <vaadin-form-layout>

                    <vaadin-text-field label="{{localize('company')}}" value="{{route.company}}" readonly>
                    </vaadin-text-field>

                    <vaadin-combo-box id="modelField" label="{{localize('model')}}" value="{{route.model}}" items="[[models]]" required
                                      readonly="[[route.archived]]">
                    </vaadin-combo-box>

                    <vaadin-combo-box id="sourceField" label="{{localize('source')}}" value="{{route.source}}" items="[[cities]]" required
                                      readonly="[[route.archived]]">
                    </vaadin-combo-box>

                    <vaadin-combo-box id="targetField" label="{{localize('target')}}" value="{{route.target}}" items="[[cities]]" required
                                      readonly="[[route.archived]]">
                    </vaadin-combo-box>

                    <paper-input id="startTimeField"
                                 type="time"
                                 value="{{route.startTime}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('start_time')}}"
                                 required="true"
                                 auto-validate="true"
                                 readonly="[[route.archived]]">
                    </paper-input>

                    <paper-input id="endTimeField"
                                 type="time"
                                 value="{{route.endTime}}"
                                 error-message="{{localize('error_invalid')}}"
                                 label="{{localize('end_time')}}"
                                 required="true"
                                 auto-validate="true"
                                 readonly="[[route.archived]]">
                    </paper-input>

                    <vaadin-text-field label="{{localize('duration')}}" value="{{route.duration}}" readonly>
                    </vaadin-text-field>

                    <vaadin-checkbox checked="{{hasNoValidDate}}" on-change="_handleHasNoValidDateValue"
                                     disabled="[[route.archived]]">{{localize('has_no_valid_date')}}
                    </vaadin-checkbox>

                    <vaadin-date-picker id="validDateField"
                                        value="{{route.validDate}}"
                                        error-message="{{localize('error_invalid')}}"
                                        label="{{localize('valid_date')}}"
                                        auto-validate="true"
                                        hidden$="[[hasNoValidDate]]"
                                        required="[[!hasNoValidDate]]"
                                        readonly="[[route.archived]]"></vaadin-date-picker>


                </vaadin-form-layout>
            </div>
            <template is="dom-if" if="{{isEditMode(mode)}}">
                <div class="form-content">
                    <hr/>
                    <div class="list-header">
                        <div class="list-header-left">
                            <h3>{{localize('reservation_sheets')}}</h3>
                            <span class="text-info">
                                <iron-icon icon="icons:info"></iron-icon>
                                {{localize('reservation_sheet_message')}}
                            </span>
                        </div>
                        <div class="list-header-right">
                        </div>
                    </div>
                    <vaadin-grid theme="row-dividers" items="{{reservationSheets}}" class="data-table-grid"
                                 column-reordering-allowed multi-sort height-by-rows>

                        <vaadin-grid-column width="25%">
                            <template class="header">
                                <vaadin-grid-sorter path="date">[[localize('reservation_sheet_date')]]</vaadin-grid-sorter>
                                <br/>
                                <vaadin-grid-filter path="date"></vaadin-grid-filter>
                            </template>
                            <template>[[item.date]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="25%">
                            <template class="header">
                                <vaadin-grid-sorter path="reservedSeats">[[localize('reservation_sheet_reserved_seats')]]</vaadin-grid-sorter>
                                <br/>
                                <vaadin-grid-filter path="reservedSeats"></vaadin-grid-filter>
                            </template>
                            <template>[[item.reservedSeats]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="25%">
                            <template class="header">
                                <vaadin-grid-sorter path="availableSeats">[[localize('reservation_sheet_available_seats')]]</vaadin-grid-sorter>
                                <br/>
                                <vaadin-grid-filter path="availableSeats"></vaadin-grid-filter>
                            </template>
                            <template>[[item.availableSeats]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="25%">
                            <template class="header">
                                <vaadin-grid-sorter path="state">[[localize('reservation_sheet_state')]]</vaadin-grid-sorter>
                                <br/>
                                <vaadin-grid-filter path="localizedState"></vaadin-grid-filter>
                            </template>
                            <template>
                                <iron-icon icon="image:lens" class$="[[_stateClass(item.state)]]"></iron-icon>&nbsp;[[localize(item.state)]]
                            </template>
                        </vaadin-grid-column>

                    </vaadin-grid>
                </div>
            </template>
            <div class="page-buttons">
                <paper-button id="archivedBtn" raised on-tap="toggleArchive" class="orange" hidden$="[[_hideArchiveAction(mode, route.archived)]]">
                    {{localize('archive')}}
                </paper-button>
                <paper-button raised on-tap="save" hidden$="[[_hideSaveAction(mode, route.archived)]]">{{localize('save')}}</paper-button>
                <paper-button raised on-tap="cancel" hidden$="[[isNoneMode(mode)]]">{{localize('cancel')}}</paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'arpa-route-form',

            properties: {
                routeId: {
                    type: String,
                    value: null,
                    notify: true
                },
                route: {
                    type: Object,
                    value: null,
                    notify: true
                },
                cities: {
                    type: Array,
                    value: null
                },
                models: {
                    type: Array,
                    value: null
                },
                company: {
                    type: String,
                    value: null
                },
                hasNoValidDate: {
                    type: Boolean,
                    value: false
                },
                reservationSheets: {
                    type: Array,
                    value: null
                }
            },

            behaviors: [Polymer.ArpaCore, Polymer.ArpaMessages, Polymer.ArpaForms, Polymer.ArpaQueries, Polymer.ArpaCollections],

            observers: [
                "_computeDuration(route.startTime, route.endTime)"
            ],

            _stateClass: function (_state) {
                return _state ? "state_" + _state.toLowerCase() : "state_undefined";
            },

            /**
             * Defines if Archive button is not visible.
             *
             * @param _mode The current mode value.
             * @param _archived  The current archived value.
             * @returns {boolean}
             * @private
             */
            _hideArchiveAction: function (_mode, _archived) {
                return _archived || !this.isEditMode(_mode);
            },

            /**
             * Defines if Save button is not visible.
             *
             * @param _mode The current mode value.
             * @param _archived  The current archived value.
             * @returns {boolean}
             * @private
             */
            _hideSaveAction: function (_mode, _archived) {
                return _archived || this.isNoneMode(_mode);
            },

            /**
             * Calculates route.duration values based on _startTime and _endTime parameters.
             *
             * @param _startTime The current start time.
             * @param _endTime The current end time.
             * @private
             */
            _computeDuration: function (_startTime, _endTime) {
                if (_startTime && _endTime) {
                    var timeStart = new Date("03/25/2018 " + _startTime + ":00");
                    var endDay = (_startTime >= _endTime ? 26 : 25);
                    var timeEnd = new Date("03/" + endDay + "/2018 " + _endTime + ":00");
                    const days = parseInt((timeEnd - timeStart) / (1000 * 60 * 60 * 24));
                    const hours = parseInt(Math.abs(timeEnd - timeStart) / (1000 * 60 * 60) % 24);
                    const minutes = parseInt(Math.abs(timeEnd.getTime() - timeStart.getTime()) / (1000 * 60) % 60);
                    var duration = (days ? days + "d " : "") + (hours ? hours + "h " : "") + (minutes ? minutes + "m " : "");
                    this.set("route.duration", duration);
                } else {
                    this.set("route.duration", 0);
                }
            },

            /**
             * Handles hasNoValidDate property to reset route.validDate property.
             *
             * @param _event The current event.
             * @private
             */
            _handleHasNoValidDateValue: function (_event) {
                if (this.hasNoValidDate) {
                    this.set("route.validDate", null);
                }
            },

            /**
             * Returns the page header label based on "mode" and "archived" parameters;
             *
             * @param _mode The current mode value.
             * @param _archived  The current archived value.
             * @returns {string}
             * @private
             */
            _getPageHeader: function (_mode, _archived) {
                var labelKey = _archived ? "view_header" : (this.isEditMode(_mode) ? "edit_header" : (this.isAddMode(_mode) ? "add_header" : "view_header"));
                return this.localize(labelKey);
            },

            /**
             * Loads cities, bus_models and current user associated company name.
             */
            _loadAssociatedData: function () {
                firebaseApp.database().ref("/cities").orderByKey().once("value")
                    .then(function (data) {
                        this.set("cities", this.getObjectKeys(data.val()))
                    }.bind(this));

                firebaseApp.database().ref("/bus_models").orderByKey().once("value")
                    .then(function (data) {
                        console.log("bus models");
                        this.set("models", this.getObjectKeys(data.val(), function (_key, _value) {
                            return _value && (_value.owner === "GLOBAL" || _value.owner === this.user.uid);
                        }.bind(this)))
                    }.bind(this));
                return this.getCurrentUserCompanyName().then(function (data) {
                    this.company = data;
                }.bind(this));
            },

            /**
             * Setups current element states and properties value based on _mode and _route parameters.
             *
             * @param _mode The form mode.
             * @param _route The route object.
             * @returns {*}
             */
            setup: function (_mode, _route) {
                this.mode = _mode;
                //Setup default values
                console.log("route", this.route);
                this.routeId = null;
                this.reservationSheets = null;
                if (this.isNoneMode(this.mode)) {
                    this.route = null;
                } else if (this.isEditMode(this.mode)) {
                    this._loadAssociatedData().then(function (data) {
                        this.routeId = _route.$id;
                        this.route = this.toEditableObject(_route);
                        this.hasNoValidDate = !this.route.validDate;
                        if (!this.route.company) {
                            this.route.company = this.company;
                        }
                        this.setPropertiesFromEntity("route", ["company", "model", "source", "target", "validDate", "startTime", "endTime", "archived"]);
                        this.clearFieldsValidation(["modelField", "sourceField", "targetField", "validDateField", "startTimeField", "endTimeField"], false);
                        firebaseApp.database().ref("/reservation_sheets/" + this.routeId).orderByChild("date").once("value")
                            .then(function (data) {
                                console.log("data.val()", data.val());
                                var reservationSheetsTemp = this.queryResultsToArrayObject(data.val());
                                for (var i = 0; reservationSheetsTemp && i < reservationSheetsTemp.length; i++) {
                                    reservationSheetsTemp[i].localizedState = this.localize(reservationSheetsTemp[i].state);
                                }
                                this.set("reservationSheets", reservationSheetsTemp);

                            }.bind(this));
                    }.bind(this));
                } else if (this.isAddMode(this.mode)) {
                    this._loadAssociatedData().then(function (data) {
                        this.routeId = null;
                        this.route = {
                            validDate: null,
                            startTime: "",
                            endTime: "",
                            company: this.company,
                            owner: this.user.uid,
                            archived: false
                        };
                        this.hasNoValidDate = true;
                        this.setPropertiesFromEntity("route", ["company", "model", "source", "target", "validDate", "startTime", "endTime", "owner", "archived"]);
                        this.clearFieldsValidation(["modelField", "sourceField", "targetField", "validDateField", "startTimeField", "endTimeField"], true);
                    }.bind(this));
                }
                return Promise.resolve();
            },

            /**
             * Toggles route.archived property to archive or unarchive route state.
             *
             * @param _event The current event.
             */
            toggleArchive: function (_event) {
                firebaseApp.database().ref(this.recordPath).child("archived")
                    .transaction(function (archived) {
                        this.set("route.archived", !archived);
                        return !archived;
                    }.bind(this))
                    .then(function (data) {
                        var archived = this.get("route.archived");
                        this.showSuccessMessage(this.localize("success_edit", "action", this.localize(archived ? "archived" : "unarchived")));
                        this.get("route.archived")
                    }.bind(this));
            },

            /**
             * Handles save action to Insert or Update current route object that is being displayed.
             *
             * @param _event The current event.
             * @returns {*}
             */
            save: function (_event) {
                if (this.performFieldsValidation(["modelField", "sourceField", "targetField", "validDateField", "startTimeField", "endTimeField"])) {
                    this.pushPropertiesToEntity("route", ["company", "model", "source", "target", "validDate", "startTime", "endTime", "owner", "archived"]);

                    if (this.isAddMode(this.mode)) {
                        var recordRef = firebaseApp.database().ref(this.routesPath);
                        var result = recordRef.push(this.route);
                        this.showSuccessMessage(this.localize("success_add"));
                    } else if (this.isEditMode(this.mode)) {
                        var recordRef = firebaseApp.database().ref(this.recordPath);
                        var result = recordRef.update(this.route);
                        this.showSuccessMessage(this.localize("success_edit"));
                    } else {
                        this.showErrorMessage(this.localize("unsupported_action"));
                    }
                    this.fire('change-view', {mode: "NONE", route: null, view: "list"});
                }
                return Promise.resolve();
            },

            /**
             * Handlers cancel action to redirect to list element.
             * @param _event  The current event.
             */
            cancel: function (_event) {
                this.fire('change-view', {mode: "NONE", route: null, view: "list"});
            },

            /**
             * Returns routes objects path reference.
             *
             * @returns {string}
             */
            get routesPath() {
                return '/routes';
            },

            /**
             * Returns current record path reference.
             * @returns {string}
             */
            get recordPath() {
                return this.routesPath + "/" + this.routeId;
            }
        });
    </script>
</dom-module>